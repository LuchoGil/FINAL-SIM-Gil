<html>

<head>

    <script src="jquery-3.3.1.min.js">
    </script>

    <script>
        $(document).ready(function () {

            //Clases y variables globales

            class Acoplado {
                constructor(numero, estado, tractor) {
                    this.numero = numero;
                    this.estado = estado;
                    this.tractor = tractor;
                }
            }

            class Tractor {
                constructor(numero, estado, horaFin, acoplado) {
                    this.numero = numero;
                    this.estado = estado;
                    this.horaFin = horaFin;
                    this.acoplado = acoplado;
                }
            }

            class Picadora extends Tractor { //tractor con una picadora              

            }

            class Transportador extends Tractor { //tractor que transportar a la embutidora           

            }

            class Empleado {
                constructor(numero, estado) {
                    this.numero = numero;
                    this.estado = estado;
                }
            }

            class Embutidora {
                constructor(numero, estado) {
                    this.numero = numero;
                    this.estado = estado;
                }
            }

            class Evento {
                constructor(nombre, hora, activo, actor) {
                    this.nombre = nombre;
                    this.hora = hora;
                    this.activo = activo;
                    this.actor = actor;
                }
            }


            var acoplado1 = new Acoplado(1, "Llenando", picadora1); //Llenando, Lleno, Libre
            var acoplado2 = new Acoplado(2, "Llenando", picadora2);
            var acoplado3 = new Acoplado(3, "Lleno", transportador1);
            var acoplado4 = new Acoplado(4, "Lleno", transportador2);

            var acoplados = [acoplado1, acoplado2, acoplado3, acoplado4];

            var picadora1 = new Picadora(1, "Llenando", 3, acoplado1);
            var picadora2 = new Picadora(1, "Llenando", 5, acoplado2);

            var picadoras = [picadora1, picadora2]

            var transportador1 = new Transportador(1, "descargando", 4, acoplado3);
            var transportador2 = new Transportador(2, "esperando descarga", "-", acoplado4);

            var transportadores = [transportador1, transportador2];

            var embutidora1 = new Embutidora(1, "Ocupada");

            var empleado1 = new Empleado(1, "Libre");


            var colaEmbutidora = [transportador2];
            var colaEnganche = [];
            var colaDesenganche = [];
            var acopladosLibres = [];
            var acopladosLlenos = [];

            var contadorEmbutidos = 0; //Lo que se debemostrar al final
            var reloj = 0;

            var tiempoEnganche = 20;
            var tiempoDesenganche = 10;

            var rndLlenada = "-";
            var tiempoLlenada = "-";
            var finLlenada = "-";
            var finEnganche = "-";
            var finDesenganche = "-";
            var rndDescarga = "-";
            var tiempoDescargar = "-";
            var finDescarga = "-";


            var fila1 = [0, 0, 99999, 99999, 99999, 99999, 99999, 99999, 1, 0, 0, 0, 0, 0];
            var arrayToDraw = [prox_evento.nombre, reloj, rndLlenada, tiempoLlenada, finLlenada, picadora1.estado, picadora1.horaFin, picadora2.estado, picadora2.horaFin, acoplado1.estado, acoplado2.estado, acoplado3.estado, acoplado4.estado, colaEnganche.length, colaDesenganche.length, empleado1.estado, finEnganche, finDesenganche, rndDescarga, tiempoDescargar, finDescarga, transportador1.estado, transportador1.horaFin, transportador2.estado, transportador2.horaFin, colaEmbutidora.length, embutidora1.estado, contadorEmbutidos]; //Array primera iteracion 28 columnas
            var draw = [0, 0, 99999, 99999, 99999, 99999, 99999, 99999, 1, 0, 0, 0, 0, 0];
            var drawArray = []; //Array a ser mostrado, es un array de arrays
            var blankArray = [99999, 99999, 99999, 99999, 99999, 99999, 99999, 99999, 99999, 99999, 99999, 99999, 99999, 99999];
            var cantfila = 0;
            var contClientes = 0;
            var columnasComparar = [4, 16, 17, 20]; //4 fin prox llenada de acoplado - 16 fin enganche prox - 17 fin desenganche proximo - 20 fin descarga en embutidora
            var primero = 0;
            var urll = window.location.href;
            var header = "<tr id='hder' class='cabeza'><th>Evento</th><th>Reloj</th><th>RND</th><th>Tiempo</th><th>Proximo</th><th>RND</th><th>Tiempo</th><th>Proximo</th><th>Estado Servidor</th><th>Cola Normal</th><th>Cola Prioridad</th><th>Cantidad Atendidos</th><th>Cant Salida Tardanza</th><th>Cant Salida Exceso</th>"
            var aftheader = "</tr>";

            $("#btn1").click(function () {
                doSimulation();
            });
            $("#btn2").click(function () {
                window.location.href = urll;
            });
            $("#btn3").click(function () {
                window.open("enunciado.html");
            });

            //CODIGO EXTRA                        
            var cola_eventos = [];
            var tiempo = tiempo;
            var reloj = 0.0;
            var index_columnas = 0;
            var mostrar_desde = mostrar_desde;
            var iteraciones = iteraciones;
            var tiempo_grua = tiempo_grua;
            var capacidad_grua = capacidad_grua;
            var min_serv_grua = min_serv_grua;
            var cont_abandonos = 0;
            var cont_atendidos = 0;
            var acum_ganancias = 0.0;
            var acum_permanencia = 0.0;
            var objetos_temporales = [];
            var columnas = ["Estado", "Reloj", "RND P1", "Tiempo lleg. P1", "Prox. lleg. P1", "RND P2", "Tiempo lleg. P2", "Prox. lleg. P2", "i de llegada",
                "Destino traslado", "Fin traslado", "Estado grua", "Cola P1", "Cola P2", "Acum. Ganancias",
                "Cont. Perdidos", "Cont. Atendidos", "Acum. Permanencia"];

            //function simular() {
            //tabla = pd.DataFrame()
            var contador_filas = 0;
            var contador_objetos = 0;

            fila_actual = [];
            fin_mostrar = false;
            ultima_fila = false;

            var eventoInicio = new Evento("Inicio Simulacion", 0, null);
            agregar_evento(eventoInicio);
            //}


            //FUNCIONES
            function doSimulation() { //MOST IMPORTANT
                var minsSimular = $("#minutos").val();
                var cantidad = $("#filas").val();
                var desdeMin = $("#desde").val();
                var contador = 0; //contador de filas

                var contador_filas = 0
                var contador_objetos = 0
                fila_actual = [];
                fin_mostrar = false;
                ultima_fila = false;

                var eventoInicio = new Evento("Inicio Simulacion", 0);
                cola_eventos.append(evento);

                while (reloj <= minsSimular) {
                    prox_evento = cola_eventos.pop(0);
                    reloj = prox_evento.hora;
                    //ultima_fila = false;

                    if (prox_evento.nombre == "Fin Llenada Acoplado") { //Como ignorar mayusculas?
                        if (empleado1.estado == "Libre") {
                            empleado1.estado == "Ocupado";
                            finDesenganche = reloj + tiempoDesenganche; //Enganche
                            var eventoAux = new Evento("Fin Desenganche Acoplado", finDesenganche, prox_evento.actor);
                            agregar_evento(eventoAux);
                            prox_evento.actor.estado == "Desenganchando";
                            prox_evento.actor.horaFin = finDesenganche;
                            prox_evento.actor.acoplado.estado == "Desenganchando";

                        }
                        else {
                            empleado1.estado == "Ocupado";
                            colaDesenganche.push(prox_evento.actor);
                            prox_evento.actor.estado == "Esperando Desenganche";
                            prox_evento.actor.horaFin == "-";
                            prox_evento.actor.acoplado.estado == "Esperando Desenganche";
                        }
                    }

                    else if (prox_evento.nombre == "Fin Desenganche Acoplado") {
                        if (prox_evento.actor.type(Picadora) && acopladosLibres.length() > 0) {
                            empleado1.estado == "Ocupado";
                            rnd = Math.random();
                            tiempoLlenada = genTiempoLlenadaAcoplado(rnd);
                            finLlenada = reloj + tiempoLlenada;
                            var eventoAux = new Evento("Fin Llenada Acoplado", finLlenada, prox_evento.actor);
                            prox_evento.actor.acoplado = null;
                            prox_evento.actor.acoplado = acopladosLibres.pop(); //Pop una vez que se ejecuta saca un elemento del array y no lo vuelve a meter?
                            prox_evento.actor.estado == "Llenando";
                            prox_evento.actor.horaFin = finLlenada;
                            prox_evento.actor.acoplado.estado == "Llenando";
                        }

                        else if (prox_evento.actor.type(Picadora) && acopladosLibres.length() == 0) { //Si no hay acoplado disponibles para enganchar
                            empleado1.estado == "Ocupado";
                            colaEnganche.push(prox_evento.actor);
                            prox_evento.actor.estado == "Esperando Enganche";
                            prox_evento.actor.horaFin == "-";
                            prox_evento.actor.acoplado.estado == "Lleno";
                            acopladosLlenos.push(prox_evento.actor.acoplado);
                            prox_evento.actor.acoplado = null;
                        }

                        else if (prox_evento.actor.type(Transportador) && colaEnganche.length == 0 && acopladosLlenos.length > 0) { // Si se desengancha un Transportador y hay cola para enganchar o desenganchar
                            empleado1.estado == "Ocupado";
                            finEnganche = reloj + tiempoEnganche;
                            var eventoAux = new Evento("Fin Enganche Acoplado", finEnganche, prox_evento.actor);
                            agregar_evento(eventoAux);
                            prox_evento.actor.estado == "Enganchando";
                            prox_evento.actor.horaFin = finEnganche;
                            prox_evento.actor.acoplado.estado == "Vacio";
                            acopladosLibres.push(prox_evento.actor.acoplado);
                            prox_evento.actor.acoplado = acopladosLlenos.pop();
                            prox_evento.actor.acoplado.estado == "Enganchando";
                        }

                        else if (prox_evento.actor.type(Transportador) && (colaEnganche.length > 0 || colaDesenganche.length > 0)) { // Si se desengancha un Transportador y hay cola para enganchar o desenganchar
                            empleado1.estado == "Ocupado";
                            colaEnganche.push(prox_evento.actor);
                            prox_evento.actor.estado == "Esperando Enganche";
                            prox_evento.actor.horaFin == "-";
                            prox_evento.actor.acoplado.estado == "Vacio";
                            acopladosLibres.push(prox_evento.actor.acoplado);
                            prox_evento.actor.acoplado = null;
                        }
                        else if (prox_evento.actor.type(Transportador) && (colaEnganche.length == 0 || colaDesenganche.length == 0)) {
                            empleado1.estado == "Libre"; //UNICO CASO DONDE SE LIBERA EL EMPLEADO DESPUES DE DESENGANCHAR UN ACOPLADO
                            colaEnganche.push(prox_evento.actor);
                            prox_evento.actor.estado == "Esperando Enganche";
                            prox_evento.actor.horaFin == "-";
                            prox_evento.actor.acoplado.estado == "Vacio";
                            acopladosLibres.push(prox_evento.actor.acoplado);
                            prox_evento.actor.acoplado = null;
                        }

                    }

                    else if (prox_evento.nombre == "Inicio Simulacion") { //agrega los eventos que se pueden identificar al inicio a la lista de eventos
                        var eventosInicio = [];
                        for (p in picadoras) {
                            if (p.horaFin = ! "-") {
                                var eventoInicio = new Evento("Fin Llenada Acoplado", p.horaFin, p);
                                eventosInicio.push(eventoInicio);
                            }
                        }
                        for (t in transportadores) {
                            if (t.horaFin = ! "-") {
                                var eventoInicio = new Evento("Fin Descarga", t.horaFin, t);
                                eventosInicio.push(eventoInicio);
                            }
                        }
                        agregar_evento(eventosInicio);
                        drawIteration();
                    }


                    //Ultima parte del evento doSimulacion()
                    doIteration();
                    reloj = arrayToDraw[1];
                    if (reloj > 600) {
                        arrayToDraw = fila1.slice()
                        arrayToDraw[0] = 1;
                        arrayToDraw[1] = 600;
                    }
                    console.log(arrayToDraw);
                    if (reloj >= desdeMin && contador <= cantidad) {
                        drawIteration();

                        contador++;
                    }

                    // Volvemos las variables a su estado original para que se muestren bien la proxima iteracion
                    var rndLlenada = "-";
                    var tiempoLlenada = "-";
                    var finLlenada = "-";
                    var finEnganche = "-";
                    var finDesenganche = "-";
                    var rndDescarga = "-";
                    var tiempoDescargar = "-";
                    var finDescarga = "-";
                }

                //Dibujar tabla
                drawTable();
                $("#jose1").text(arrayToDraw[11]);
                $("#jose2").text(arrayToDraw[12]);
                $("#jose3").text(arrayToDraw[13]);
            }



            function agregar_evento(eventos) {
                if (type(eventos) != list) {
                    cola_eventos.push(eventos)
                }
                else {
                    for (e in eventos) {
                        cola_eventos.push(e);
                    }
                }
                cola_eventos.sort(function (a, b) { return a.hora - b.hora });
            }




            function doIteration() {
                if (reloj == 0) { }
                else {
                    fila1 = arrayToDraw.slice();
                    var nextEvent = getNextEvent();
                    arrayToDraw[0] = nextEvent;
                    arrayToDraw[1] = fila1[nextEvent]; //Reloj de proximo evento que va a ser dibujado
                    //arrayToDraw[2] = 99999;
                    //arrayToDraw[3] = 99999;
                    //arrayToDraw[5] = 99999;
                    //arrayToDraw[6] = 99999;
                    processEvent(nextEvent);
                }
                cantfila++;
            }

            function drawIteration() {
                draw = arrayToDraw.slice();   //draw es el array que se va a dibujar                            
                for (i in draw) {
                    switch (i) { // Cambiar if por switch
                        case 0: defineEvent(); break; //Nombre del evento que ocurre
                        case 1: ; // deberia llegarle el reloj o ya estar definido de antes
                        case 2: ; //
                        case 3: ;
                        case 4: ;
                        case 5: ;
                        case 6: ;
                        case 7: ;
                        case 8: ;
                        case 9: ;
                        case 10: ;
                        case 11: ;
                        case 12: ;
                        case 13: ;
                        case 14: ;
                        case 15: ;
                        case 16: ;
                        case 17: ;
                        case 18: ;
                        case 19: ;
                        case 28: ;
                    }
                    //var cambio = false;
                    //if (i == 0) { defineEvent(); cambio = true; }
                    //todas las definiciones necesarias a considerar en el array                    
                    //if (i == 8) { defineEstadoServer(); cambio = true; }
                    //if (i > 14 && !cambio) {
                    //if (draw[i] == 0) { draw[i] = "C"; cambio = true; }
                    //if (draw[i] == 1) { draw[i] = "EV"; cambio = true; }
                    //if (draw[i] == 2) { draw[i] = "CP"; cambio = true; }
                    //if (draw[i] == 3) { draw[i] = "SA"; cambio = true; }
                }
                drawArray.push(draw.slice());
            }

            function updateTable() { //Para agregar mas columnas a la tabla
                if (fila1.length != arrayToDraw.length) {
                    $("#hder").append("<th>Proximo C" + contClientes + "</th><th>Estado C" + contClientes + "</th>");
                }
                $("#tabla").append("<tr id=fila" + cantfila + "></tr>");
                for (i in draw) {
                    $("#fila" + cantfila + "").append("<td>" + draw[i] + "</td>");
                }
            }

            function defineEvent() {
                var event = draw[0];
                if (event == 0) { draw[0] = "Inicio Simulacion"; return 1; }
                if (event == 1) { draw[0] = "Fin Simulación"; return 1; }
                if (event == 4) { draw[0] = "Fin Llenada Acoplado"; return 1; }
                if (event == 16) { draw[0] = "Fin Enganche Acoplado"; return 1; }
                if (event == 17) { draw[0] = "Fin Desenganche Acoplado"; return 1; }
                if (event == 20) { draw[0] = "Fin Descarga"; return 1; }
            }

            //function defineEstadoServer() {
            //    if (draw[8] == 0) { draw[8] = "OCUPADO"; return 1; }
            //    else { draw[8] = "LIBRE"; };
            //}

            function truncateDecimal(numero) {
                var with2Decimals = numero.toString().match(/^-?\d+(?:\.\d{0,2})?/)[0]
                return with2Decimals;
            }


            //function firstIteration() {
            //}

            function getNextEvent() {
                var nextEvent = 0;
                var minClock = 9999999;
                for (i in columnasComparar) {
                    if (fila1[columnasComparar[i]] < minClock) { nextEvent = columnasComparar[i]; minClock = fila1[columnasComparar[i]]; }
                }
                return nextEvent; //Devuelve el numerode la clumna que contiene el proximo evento, lo que te permite tambien, saber cual va a ser el proximo evento
            }

            function processEvent(next) {
                if (next == 4) {
                    doFinLlenada();
                    return 1;
                }
                if (next == 16) {
                    doNuevoEnganche();
                    return 1;
                }
                if (fila1[next + 17] == 0) {
                    doNuevoDesenganche(next);
                    return 1;
                }
                if (fila1[next + 20] == 1) {
                    doNuevaDescarga(next);
                    return 1;
                }
            }

            function doFinLlenada(picadora, acoplado) {


            }

            function doNuevoEnganche() {

                // Lo de abajo genera nuevotiempo de llenado y lo coloca en el array
                var rnd = Math.random();
                var tiempo = genTiempoLlenadaAcoplado(rnd);
                var proximo = tiempo + arrayToDraw[1];
                arrayToDraw[2] = rnd;
                arrayToDraw[3] = tiempo;
                arrayToDraw[4] = proximo;
            }



            function doNuevoDesenganche(next) {
                arrayToDraw[9]--;
                arrayToDraw[next] = arrayToDraw[next] + 60;
                arrayToDraw[next + 1] = 1;
            }


            function doNuevoEventoFin() {
                var rnd = Math.random();
                var tiempo = genTiempoFin(rnd);
                var proximo = tiempo + arrayToDraw[1];
                arrayToDraw[5] = rnd;
                arrayToDraw[6] = tiempo;
                arrayToDraw[7] = proximo;
                arrayToDraw[8] = 0;
                arrayToDraw[arrayToDraw.length - 2] = 99999;
                arrayToDraw[arrayToDraw.length - 1] = 3;
            }

            //GENERADORES DE TIMPOS
            function genTiempoLlenadaAcoplado(rnd) { //exponencial negativa -9 (llenar el acoplado de maiz)
                var median = -9;
                var dentrolog = 1 - rnd;
                var valor = median * Math.log(dentrolog);
                return valor;
            }

            function genTiempoFinEmbutir(rnd) { //uniforme  media 4.5 min con desviacion 0.5 min (descargar en embutidora)
                var tiempo = 4.5 + (rnd * 0.5);
                return tiempo;
            }

            function contains(x, ar) {
                console.log("Entre a contain");
                for (i in ar) {
                    if (x == ar[i]) { return true; }
                }
                return false;
            }

            //Dibujo de la tabla final antes de mostrar
            function drawTable() {
                var conTabla = "";
                header = header.concat(aftheader);
                conTabla = conTabla.concat(header); //concatena una nueva fila
                for (i in drawArray) {
                    conTabla = conTabla.concat("<tr>");
                    for (j in drawArray[i]) {
                        conTabla = conTabla.concat("<td>" + drawArray[i][j] + "</td>");
                    }
                    conTabla = conTabla.concat("</tr>");
                }
                $("#tabla").append(conTabla);
                console.log(conTabla);
                console.log("FIN DRAW");
            }
        });
    </script>

    <style>
        table {
            border-collapse: collapse;
        }

        table,
        th,
        td {
            border: 1px solid black;
            text-align: center;
            vertical-align: center;
        }

        th,
        td {
            padding: 5px;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2
        }

        #box1 {
            float: left;
            width: 25%;
            padding: 20px;
        }

        #box2 {
            float: left;
            width: 25%;
            padding: 20px;
        }

        #tabla {
            width: 100%;
        }

        .btn {
            padding: 5px;
            margin: 4px;
        }
    </style>
</head>

<body>
    <div id="box1">
        <form>
            Minutos a simular:
            <br>
            <input type="text" id="minutos" value="600">
            <br> Cantidad de filas a mostrar:
            <br>
            <input type="text" id="filas" value="100">
            <br> A partir de minuto:
            <br>
            <input type="text" id="desde" value="0">
            <br>
        </form>
    </div>

    <div id="box2">
        <br> Clientes Atendidos:
        <b id="jose1"></b>
        <br> Clientes perdidos por tardanza:
        <b id="jose2"></b>
        <br> Clientes perdidos por exceso:
        <b id="jose3"></b>
        <br>
    </div>

    <button type="button" class="btn" id="btn1">Simular</button>
    <br>
    <button type="button" class="btn" id="btn2">Reiniciar</button>
    <br>
    <button type="button" class="btn" id="btn3">Ver Enunciado</button>
    <br>
    <div style="height: 750px; overflow-y: auto; width:100%;">
        <table id="tabla" class="table table-hover table-mc-light-blue">
            <!-- <tr id="hder"> -->
            <!-- <th>Evento</th> -->
            <!-- <th>Reloj</th> -->
            <!-- <th>RND</th> -->
            <!-- <th>Tiempo</th> -->
            <!-- <th>Proximo</th> -->
            <!-- <th>RND</th> -->
            <!-- <th>Tiempo</th> -->
            <!-- <th>Proximo</th> -->
            <!-- <th>Estado Servidor</th> -->
            <!-- <th>Cola Normal</th> -->
            <!-- <th>Cola Prioridad</th> -->
            <!-- <th>Cantidad Atendidos</th> -->
            <!-- <th>Cant Salida Tardanza</th> -->
            <!-- <th>Cant Salida Exceso</th> -->
            <!--  -->
        </table>
    </div>

</body>

</html>