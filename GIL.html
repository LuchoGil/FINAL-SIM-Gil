<html>

<head>

    <script src="jquery-3.3.1.min.js">
    </script>

    <script>
        $(document).ready(function () {

            //Clases y variables globales
            class Acoplado {
                constructor(numero, estado, tractor) {
                    this.numero = numero;
                    this.estado = estado;
                    this.tractor = tractor;
                }
            }

            class Tractor {
                constructor(numero, estado, horaFin, acoplado) {
                    this.numero = numero;
                    this.estado = estado;
                    this.horaFin = horaFin;
                    this.acoplado = acoplado;
                }
            }

            class Picadora extends Tractor { //tractor con una picadora              

            }

            class Transportador extends Tractor { //tractor que transportar a la emutidora1           

            }

            class Empleado {
                constructor(numero, estado) {
                    this.numero = numero;
                    this.estado = estado;
                }
                trabajar() {
                    // ---- Cola picadora para enganchar y hay acoplados libre -> Engancha Picadora
                    if (colaEnganchePicadoras.length > 0 && acopladosLibres.length > 0) {
                        empleado1.estado = "Ocupado";
                        var p = colaEnganchePicadoras.pop();
                        finEnganche = reloj + tiempoEnganche;
                        var eventoAux = new Evento("Fin Enganche Acoplado", finEnganche, p);
                        agregarEvento(eventoAux);
                        p.acoplado = acopladosLibres.pop();
                        p.acoplado.estado = "Enganchando";
                        p.estado = "Enganchando " + p.acoplado.numero;
                        p.horaFin = finEnganche;
                    }
                    // Cola picadora para enganchar y no hay acoplados libres y hay cola transportadores para desenganchar -> Desengancha transportadora
                    else if (colaEnganchePicadoras.length > 0 && acopladosLibres.length == 0 && colaDesengancheTransportadores.length > 0) {
                        empleado1.estado = "Ocupado";
                        var t = colaDesengancheTransportadores.pop();
                        finDesenganche = reloj + tiempoDesenganche; //Enganche
                        var eventoAux = new Evento("Fin Desenganche Acoplado", finDesenganche, t);
                        agregarEvento(eventoAux);
                        t.acoplado.estado = "Desenganchando";
                        t.estado = "Desenganchando " + t.acoplado.numero;
                        t.horaFin = finDesenganche;
                    }
                    // Cola picadora para enganchar y no hay acoplados libres y no hay cola transportadores para desenganchar y hay cola transportadores para enganchar y hay acoplados llenos -> Engancha transportador
                    else if (colaEnganchePicadoras.length > 0 && acopladosLibres.length == 0 && colaDesengancheTransportadores.length == 0 && acopladosLlenos.length > 0 && colaEngancheTransportadores.length > 0) {
                        empleado1.estado = "Ocupado";
                        var t = colaEngancheTransportadores.pop();
                        finEnganche = reloj + tiempoEnganche;
                        var eventoAux = new Evento("Fin Enganche Acoplado", finEnganche, t);
                        agregarEvento(eventoAux);
                        t.acoplado = acopladosLlenos.pop();
                        t.acoplado.estado = "Enganchando";
                        t.estado = "Enganchando " + t.acoplado.numero;
                        t.horaFin = finEnganche;
                    }
                    // Cola picadora para enganchar y no hay acoplados libres y no hay cola transportadores para desenganchar y hay cola transportadores para enganchar y no hay acoplados llenos y hay picadoras para desenganchar-> Desengancha picadora 
                    else if (colaEnganchePicadoras.length > 0 && acopladosLibres.length == 0 && colaDesengancheTransportadores.length > 0 && acopladosLlenos.length == 0 && colaDesenganchePicadoras.length > 0) {
                        empleado1.estado = "Ocupado";
                        var p = colaDesenganchePicadoras.pop();
                        finDesenganche = reloj + tiempoDesenganche; //Enganche
                        var eventoAux = new Evento("Fin Desenganche Acoplado", finDesenganche, p);
                        agregarEvento(eventoAux);
                        p.acoplado.estado = "Desenganchando";
                        p.estado = "Desenganchando " + p.acoplado.numero;
                        p.horaFin = finDesenganche;
                    }

                    // Cola picadora para enganchar y no hay acoplados libres y no hay cola transportadores para desenganchar y hay cola transportadores para enganchar y no hay acoplados llenos y no hay picadoras para desenganchar -> Empleado libre 
                    else if (colaEnganchePicadoras.length > 0 && acopladosLibres.length == 0 && colaDesengancheTransportadores.length > 0 && acopladosLlenos.length == 0 && colaDesenganchePicadoras.length == 0) {
                        empleado1.estado = "Libre";
                    }
                    // ---- No hay cola picadora para enganchar y hay cola transportador para enganchar  y hay acoplado llenos -> Engancha transportador                
                    else if (colaEnganchePicadoras.length == 0 && colaEngancheTransportadores.length > 0 && acopladosLlenos.length > 0) {
                        empleado1.estado = "Ocupado";
                        var t = colaEngancheTransportadores.pop();
                        finEnganche = reloj + tiempoEnganche;
                        var eventoAux = new Evento("Fin Enganche Acoplado", finEnganche, t);
                        agregarEvento(eventoAux);
                        t.acoplado = acopladosLlenos.pop();
                        t.acoplado.estado = "Enganchando";
                        t.estado = "Enganchando " + t.acoplado.numero;
                        t.horaFin = finEnganche;
                    }
                    // ---- No hay cola picadora para enganchar y hay cola picadora para desenganchar -> Desengancha picadora
                    else if (colaEnganchePicadoras.length == 0 && colaDesenganchePicadoras.length > 0) {
                        empleado1.estado = "Ocupado";
                        var p = colaDesenganchePicadoras.pop();
                        finDesenganche = reloj + tiempoDesenganche; //Enganche
                        var eventoAux = new Evento("Fin Desenganche Acoplado", finDesenganche, p);
                        agregarEvento(eventoAux);
                        p.acoplado.estado = "Desenganchando";
                        p.estado = "Desenganchando " + p.acoplado.numero;
                        p.horaFin = finDesenganche;
                    }
                    // ---- No hay cola picadora para enganchar y hay cola transportador para desenganchar ->Desengancha transportador   
                    else if (colaEnganchePicadoras.length == 0 && colaDesengancheTransportadores.length > 0) {
                        empleado1.estado = "Ocupado";
                        var t = colaDesengancheTransportadores.pop();
                        finDesenganche = reloj + tiempoDesenganche; //Enganche
                        var eventoAux = new Evento("Fin Desenganche Acoplado", finDesenganche, t);
                        agregarEvento(eventoAux);
                        t.acoplado.estado = "Desenganchando";
                        t.estado = "Desenganchando " + t.acoplado.numero;
                        t.horaFin = finDesenganche;
                    }
                    // else empleado libre
                    else {
                        empleado1.estado = "Libre";
                    }
                }
            }

            class emutidora1 {
                constructor(numero, estado) {
                    this.numero = numero;
                    this.estado = estado;
                }
            }

            class Evento {
                constructor(nombre, hora, actor) {
                    this.nombre = nombre;
                    this.hora = hora;
                    this.actor = actor;
                }
            }


            var acoplado1 = new Acoplado(1, "Llenando", picadora1); //Llenando, Lleno, Libre
            var acoplado2 = new Acoplado(2, "Llenando", picadora2);
            var acoplado3 = new Acoplado(3, "Lleno", transportador1);
            var acoplado4 = new Acoplado(4, "Lleno", transportador2);

            //  var acoplados = [acoplado1, acoplado2, acoplado3, acoplado4];

            var picadora1 = new Picadora(1, "Llenando", 3, acoplado1);
            var picadora2 = new Picadora(2, "Llenando", 5, acoplado2);

            var picadoras = [picadora1, picadora2]

            var transportador1 = new Transportador(1, "Descargando", 4, acoplado3);
            var transportador2 = new Transportador(2, "Esperando Descarga", "-", acoplado4);

            var transportadores = [transportador1, transportador2];

            var embutidora1 = new emutidora1(1, "Ocupada");

            var empleado1 = new Empleado(1, "Libre");

            // Colas!!!!
            var colaEmbutidora = [transportador2];
            var colaEnganchePicadoras = [];
            var colaDesenganchePicadoras = [];
            var colaEngancheTransportadores = [];
            var colaDesengancheTransportadores = [];
            var acopladosLibres = [];
            var acopladosLlenos = [];

            var contadorEmbutidos = 0; //Lo que se debemostrar al final
            var reloj = 0;

            //Cambiar para obtener otros tiempos
            var tiempoEnganche = 20;
            var tiempoDesenganche = 10;


            var rndLlenada = "-";
            var tiempoLlenada = "-";
            var finLlenada = "-";
            var finEnganche = "-";
            var finDesenganche = "-";
            var rndDescarga = "-";
            var tiempoDescarga = "-";
            var finDescarga = "-";

            //CODIGO EXTRA                        
            var colaEventos = [];
            var reloj = 0.0;

            // Evento queda inicio todo
            var proxEvento = new Evento("Inicio Simulacion", 0);
            colaEventos.push(proxEvento);
            
            var arrayToDraw = [proxEvento.nombre, reloj, rndLlenada, tiempoLlenada, finLlenada, picadora1.estado, picadora1.horaFin, picadora2.estado, picadora2.horaFin, colaEnganchePicadoras.length, colaDesenganchePicadoras.length, acoplado1.estado, acoplado2.estado, acoplado3.estado, acoplado4.estado, acopladosLibres.length, acopladosLlenos.length, , empleado1.estado, finEnganche, finDesenganche, rndDescarga, tiempoDescarga, finDescarga, transportador1.estado, transportador1.horaFin, transportador2.estado, transportador2.horaFin, colaEngancheTransportadores, colaDesengancheTransportadores, colaEmbutidora.length, embutidora1.estado, contadorEmbutidos]; //Array primera iteracion 28 columnas
            var draw = [0, 0, 99999, 99999, 99999, 99999, 99999, 99999, 1, 0, 0, 0, 0, 0];
            var drawArray = []; //Array a ser mostrado, es un array de arrays

            var urll = window.location.href;

            var header =
                "<tr id='hder' class='cabeza'><th>Evento</th><th>Reloj</th><th>RND</th><th>Tiempo Llenada</th><th>Fin Llenada</th><th>P1 Estado</th>< th > P1 Fin</th> <th>P2 Estado</th> <th>P2 Fin </th> <th>C Enganche P</th> <th>C Desenganche P</th> <th>A1 Estado</th> <th>A2 Estado</th> <th>A3 Estado</th> <th>A4 Estado</th> <th>A Libres</th> <th>A Llenos</th> <th>Empleado</th> <th>Fin Enganche</th> <th>Fin Desenganche</th> <th>RND</th> <th>T Descarga</th> <th>Fin Descarga</th> <th>T1 Estado</th> <th>T1 Fin</th> <th>T2 Estado</th> <th>T2 Fin</th> <th>C Enganche Transportadores</th> <th>C Desenganche Transportadores</th> <th>Cola emutidora1</th> <th>Emb Estado</th> <th>Cantidad Embutidos</th>";
            var aftheader = "</tr>";

            //Botones
            $("#btn1").click(function () {
                doSimulation();
            });
            $("#btn2").click(function () {
                window.location.href = urll;
            });
            $("#btn3").click(function () {
                window.open("enunciado.html");
            });

            //FUNCIONES
            function doSimulation() {

                var minsSimular = $("#minutos").val();
                var cantidad = $("#filas").val();
                var desdeMin = $("#desde").val();
                var contador = 0; //contador de filas

                while (reloj <= minsSimular) {

                    proxEvento = colaEventos.pop(0);
                    reloj = proxEvento.hora;

                    //ultimaFila = false;                    
                    if (proxEvento.nombre == "Fin Llenada Acoplado") {
                        if (empleado1.estado == "Libre") {
                            empleado1.estado = "Ocupado";
                            finDesenganche = reloj + tiempoDesenganche; //Enganche
                            var eventoAux = new Evento("Fin Desenganche Acoplado", finDesenganche, proxEvento.actor);
                            agregarEvento(eventoAux);
                            proxEvento.actor.estado = "Desenganchando " + proxEvento.actor.acoplado.numero;
                            proxEvento.actor.horaFin = finDesenganche;
                            proxEvento.actor.acoplado.estado = "Desenganchando";
                        } else {
                            colaDesenganchePicadoras.push(proxEvento.actor);
                            proxEvento.actor.estado = "Esperando Desenganche " + proxEvento.actor.acoplado.numero;
                            proxEvento.actor.horaFin = "-";
                            proxEvento.actor.acoplado.estado = "Esperando Desenganche";
                        }
                    }

                    else if (proxEvento.nombre == "Fin Desenganche Acoplado") {
                        if (proxEvento.actor.constructor.name == "Transportador") {
                            proxEvento.actor.acoplado.estado = "Libre";
                            acopladosLibres.push(proxEvento.actor.acoplado);
                            proxEvento.actor.acoplado = null;
                            proxEvento.actor.estado = "Libre";
                            proxEvento.actor.horaFin = "-";
                            colaEngancheTransportadores.push(proxEvento.actor);
                            empleado1.trabajar();
                        }
                        else {
                            proxEvento.actor.acoplado.estado = "Lleno";
                            acopladosLlenos.push(proxEvento.actor.acoplado);
                            proxEvento.actor.acoplado = null;
                            proxEvento.actor.estado = "Libre";
                            proxEvento.actor.horaFin = "-";
                            colaEnganchePicadoras.push(proxEvento.actor);
                            empleado1.trabajar();
                        }

                    } else if (proxEvento.nombre == "Fin Enganche Acoplado") {
                        if (proxEvento.actor.constructor.name == "Transportador") {
                            proxEvento.actor.acoplado.estado = "Enganchado";
                            proxEvento.actor.estado = "Enganchado " + proxEvento.actor.acoplado.numero;
                            empleado1.trabajar();
                            if (colaEmbutidora.length == 0) {
                                rndDescarga = Math.random();
                                tiempoDescarga = genTiempoFinEmbutir(rndDescarga);
                                finDescarga = reloj + tiempoDescarga;
                                var eventoAux = new Evento("Fin Descarga Acoplado", finDescarga, proxEvento.actor);
                                agregarEvento(eventoAux);
                                proxEvento.actor.estado = "Descargando";
                                proxEvento.actor.horaFin = finDescarga;
                                proxEvento.actor.acoplado.estado = "Descargando";
                                emutidora1.estado = "Ocupada";
                            }
                        }
                        else {
                            proxEvento.actor.acoplado.estado = "Enganchado";
                            proxEvento.actor.estado = "Enganchado " + proxEvento.actor.acoplado.numero;
                            empleado1.trabajar();
                            rndLlenada = Math.random();
                            tiempoLlenada = genTiempoLlenadaAcoplado(rndLlenada);
                            finLlenada = reloj + tiempoLlenada;
                            var eventoAux = new Evento("Fin Llenada Acoplado", finLlenada, proxEvento.actor);
                            agregarEvento(eventoAux);
                            proxEvento.actor.estado = "Lllenando";
                            proxEvento.actor.horaFin = finLlenada;
                            proxEvento.actor.acoplado.estado = "Llenando";
                        }

                    } else if (proxEvento.nombre == "Fin Descarga") {
                        contadorEmbutidos++; //Sumar uno al contador
                        if (colaEmbutidora.length == 0) {
                            emutidora1.estado = "Libre";
                        }
                        else {
                            t = colaEmbutidora.pop();
                            rndDescarga = Math.random();
                            tiempoDescarga = genTiempoFinEmbutir(rndDescarga);
                            finDescarga = reloj + tiempoDescarga;
                            var eventoAux = new Evento("Fin Descarga Acoplado", finDescarga, t);
                            agregarEvento(eventoAux);
                            t.estado = "Descargando";
                            t.horaFin = finDescarga;
                            t.acoplado.estado = "Descargando";
                            embutidora1.estado = "Ocupada";
                        }
                        proxEvento.actor.estado = "Esperando Desenganche";
                        proxEvento.actor.horaFin = "-"
                        colaDesengancheTransportadores.push(proxEvento.actor);
                        proxEvento.actor.acoplado.estado = "Lleno";
                        acopladosLlenos.push(proxEvento.actor.acoplado)
                        empleado1.trabajar();

                    } else if (proxEvento.nombre == "Inicio Simulacion") { //agrega los eventos que se pueden identificar al inicio a la lista de eventos
                        var eventosInicio = [];
                        for (var p of picadoras) {
                            if (p.horaFin != "-") {
                                var eventoInicio = new Evento("Fin Llenada Acoplado", p.horaFin, p);
                                eventosInicio.push(eventoInicio);
                            }
                        }
                        for (var t of transportadores) {
                            if (t.horaFin != "-") {
                                var eventoInicio = new Evento("Fin Descarga", t.horaFin, t);
                                eventosInicio.push(eventoInicio);
                            }
                        }
                        agregarEvento(eventosInicio);
                    }

                    //Ultima parte del evento doSimulacion() 
                    if (reloj > 600) {
                        drawIteration();
                        break;
                    }
                    //console.log(arrayToDraw);
                    else if (reloj >= desdeMin && contador <= cantidad) {
                        drawIteration();
                        contador++;
                    }

                    // Volvemos las variables a su estado original para que se muestren bien la proxima iteracion                    
                    var rndLlenada = "-";
                    var tiempoLlenada = "-";
                    var finLlenada = "-";
                    var finEnganche = "-";
                    var finDesenganche = "-";
                    var rndDescarga = "-";
                    var tiempoDescarga = "-";
                    var finDescarga = "-";
                }

                //Dibujar tabla al sair del while
                drawTable();
                $("#jose1").text(contadorEmbutidos);
            }

            function agregarEvento(eventos) {
                if (!Array.isArray(eventos)) {
                    colaEventos.push(eventos);
                } else {
                    for (var e of eventos) {
                        colaEventos.push(e);
                    }
                }
                colaEventos.sort(function (a, b) {
                    return b.hora - a.hora;
                });
            }

            function doIteration() {
                if (reloj == 0) { } else {
                    fila1 = arrayToDraw.slice();
                    var nextEvent = getNextEvent();
                    arrayToDraw[0] = nextEvent;
                    arrayToDraw[1] = fila1[nextEvent]; //Reloj de proximo evento que va a ser dibujado
                    //arrayToDraw[2] = 99999;
                    //arrayToDraw[3] = 99999;
                    //arrayToDraw[5] = 99999;
                    //arrayToDraw[6] = 99999;
                    processEvent(nextEvent);
                }
                cantfila++;
            }

            function drawIteration() {
                draw = arrayToDraw.slice(); //draw es el array que se va a dibujar                            
                //for (var i of draw) {
                //  switch (i) { // Cambiar if por switch
                //    case 0: defineEvent(); break; //Nombre del evento que ocurre
                //    case 1: ; // deberia llegarle el reloj o ya estar definido de antes
                //   case 2: ; //
                //   case 3: ;
                //  case 4: ;
                //  case 5: ;
                //   case 6: ;
                //  case 7: ;
                //  case 8: ;
                //  case 9: ;
                // case 10: ;
                //  case 11: ;
                //  case 12: ;
                //  case 13: ;
                //   case 14: ;
                //   case 15: ;
                //  case 16: ;
                //   case 17: ;
                //   case 18: ;
                //   case 19: ;
                //  case 28: ;
                //}
                //var cambio = false;
                //if (i == 0) { defineEvent(); cambio = true; }
                //todas las definiciones necesarias a considerar en el array                    
                //if (i == 8) { defineEstadoServer(); cambio = true; }
                //if (i > 14 && !cambio) {
                //if (draw[i] == 0) { draw[i] = "C"; cambio = true; }
                //if (draw[i] == 1) { draw[i] = "EV"; cambio = true; }
                //if (draw[i] == 2) { draw[i] = "CP"; cambio = true; }
                //if (draw[i] == 3) { draw[i] = "SA"; cambio = true; }
                //}
                drawArray.push(draw.slice());
            }

            function updateTable() { //Para agregar mas columnas a la tabla
                if (fila1.length != arrayToDraw.length) {
                    $("#hder").append("<th>Proximo C " + contClientes + "</th><th>Estado C " + contClientes +
                        "</th>");
                }
                $("#tabla").append("<tr id=fila " + cantfila + "></tr>");
                for (var i of draw) {
                    $("#fila " + cantfila + "").append("<td> " + draw[i] + "</td>");
                }
            }

            function defineEvent() {
                var event = draw[0];
                if (event == 0) {
                    draw[0] = "Inicio Simulacion";
                    return 1;
                }
                if (event == 1) {
                    draw[0] = "Fin Simulación";
                    return 1;
                }
                if (event == 4) {
                    draw[0] = "Fin Llenada Acoplado";
                    return 1;
                }
                if (event == 16) {
                    draw[0] = "Fin Enganche Acoplado";
                    return 1;
                }
                if (event == 17) {
                    draw[0] = "Fin Desenganche Acoplado";
                    return 1;
                }
                if (event == 20) {
                    draw[0] = "Fin Descarga";
                    return 1;
                }
            }

            function truncateDecimal(numero) {
                var with2Decimals = numero.toString().match(/^-?\d+(?:\.\d{0,2})?/)[0]
                return with2Decimals;
            }

            //GENERADORES DE TIMPOS
            function genTiempoLlenadaAcoplado(rnd) { //exponencial negativa -9 (llenar el acoplado de maiz)
                var median = -9;
                var dentrolog = 1 - rnd;
                var valor = median * Math.log(dentrolog);
                return valor;
            }

            function genTiempoFinEmbutir(rnd) { //uniforme  media 4.5 min con desviacion 0.5 min (descargar en emutidora1)
                var tiempo = 4.5 + (rnd * 0.5);
                return tiempo;
            }

            //Dibujo de la tabla final antes de mostrar
            function drawTable() {
                var conTabla = "";
                header = header.concat(aftheader);
                conTabla = conTabla.concat(header); //concatena una nueva fila
                for (var i = 0; i < drawArray.length; i++) {
                    conTabla = conTabla.concat("<tr>");
                    for (var j = 0; j < drawArray[i].length; j++) {
                        conTabla = conTabla.concat("<td> " + drawArray[i][j] + "</td>");
                    }
                    conTabla = conTabla.concat("</tr>");
                }

                $("#tabla").append(conTabla);
                console.log(conTabla);
                console.log("FIN DRAW");

            }

        });

    </script>

    <style>
        table {
            border-collapse: collapse;
        }

        table,
        th,
        td {
            border: 1px solid black;
            text-align: center;
            vertical-align: center;
        }

        th,
        td {
            padding: 5px;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2
        }

        #box1 {
            float: left;
            width: 25%;
            padding: 20px;
        }

        #box2 {
            float: left;
            width: 25%;
            padding: 20px;
        }

        #tabla {
            width: 100%;
        }

        .btn {
            padding: 5px;
            margin: 4px;
        }
    </style>
</head>

<body>
    <div id="box1">
        <form>
            Minutos a simular:
            <br>
            <input type="text" id="minutos" value="600">
            <br> Cantidad de filas a mostrar:
            <br>
            <input type="text" id="filas" value="100">
            <br> A partir de minuto:
            <br>
            <input type="text" id="desde" value="0">
            <br>
        </form>
    </div>

    <div id="box2">
        <br> Cantiad de Embutidos:
        <b id="jose1"></b>
    </div>

    <button type="button" class="btn" id="btn1">Simular</button>
    <br>
    <button type="button" class="btn" id="btn2">Reiniciar</button>
    <br>
    <button type="button" class="btn" id="btn3">Ver Enunciado</button>
    <br>
    <div style="height: 750px; overflow-y: auto; width:100%;">
        <table id="tabla" class="table table-hover table-mc-light-blue">
            <!-- <tr id="hder"> -->
            <!-- <th>Evento</th> -->
            <!-- <th>Reloj</th> -->
            <!-- <th>RND</th> -->
            <!-- <th>Tiempo</th> -->
            <!-- <th>Proximo</th> -->
            <!-- <th>RND</th> -->
            <!-- <th>Tiempo</th> -->
            <!-- <th>Proximo</th> -->
            <!-- <th>Estado Servidor</th> -->
            <!-- <th>Cola Normal</th> -->
            <!-- <th>Cola Prioridad</th> -->
            <!-- <th>Cantidad Atendidos</th> -->
            <!-- <th>Cant Salida Tardanza</th> -->
            <!-- <th>Cant Salida Exceso</th> -->
            <!--  -->
        </table>
    </div>

</body>

</html>